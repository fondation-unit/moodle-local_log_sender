{"version":3,"file":"generate_report.min.js","sources":["../src/generate_report.js"],"sourcesContent":["define(['jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/url'],\n    function ($, Ajax, Notification, Str, Url) {\n        'use strict';\n\n        var GenerateReport = function (requestorId, userId, userName, contextId) {\n            this.requestorId = parseInt(requestorId);\n            this.userId = parseInt(userId);\n            this.userName = userName;\n            this.start = null;\n            this.end = null;\n            this.contextId = contextId;\n            this.timer = 2500;\n            this.file = false;\n            this.formdata = {};\n            this.polling = null;\n\n            $('#submitdate').click(function (e) {\n                e.preventDefault();\n\n                const startDate = Math.floor(document.querySelector('#start-input').valueAsNumber / 1000);\n                const endDate = Math.floor(document.querySelector('#end-input').valueAsNumber / 1000);\n                const completion = this.checkCompletion(startDate, endDate);\n\n                const icon = $('<img/>');\n                icon.attr('alt', 'loading');\n                icon.attr('title', 'loading');\n                icon.attr('class', 'local_log_sender_icon loader');\n                icon.attr('src', Url.imageUrl('loading', 'local_log_sender'));\n\n                if (!completion) {\n                    return Notification.alert(\n                        Str.get_string('error'),\n                        Str.get_string('error:completiondates', 'local_log_sender')\n                    );\n                }\n\n                var formdata = {\n                    requestorid: this.requestorId,\n                    userid: this.userId,\n                    username: this.userName,\n                    startdate: startDate,\n                    enddate: endDate,\n                    contextid: this.contextId\n                };\n\n                this.formdata = formdata;\n\n                Ajax.call([{\n                    methodname: 'local_log_sender_generate_time_report',\n                    args: { jsonformdata: JSON.stringify(formdata) },\n                    done: function () {\n                        Str.get_string('client:reportgenerating', 'local_log_sender').done(function (str) {\n                            $('#report-area').addClass('alert-warning')\n                                .html(str).prepend(icon);\n                        });\n\n                        var that = this;\n\n                        (function _poll() {\n                            that.polling = setInterval(pollFile.bind(that), 7500);\n                        })();\n                    }.bind(this),\n                    fail: Notification.exception\n                }]);\n            }.bind(this));\n        };\n\n        GenerateReport.prototype.checkCompletion = function (startDate, endDate) {\n            if (startDate.length == 0 || endDate.length == 0) {\n                return false;\n            }\n            return true;\n        };\n\n        var pollFile = function () {\n            const dlicon = $('<img/>');\n            dlicon.attr('alt', 'download');\n            dlicon.attr('title', 'download');\n            dlicon.attr('class', 'local_log_sender_icon');\n            dlicon.attr('src', Url.imageUrl('download', 'local_log_sender'));\n\n            Ajax.call([{\n                methodname: 'local_log_sender_poll_report_file',\n                args: { jsonformdata: JSON.stringify(this.formdata) },\n                done: function (data) {\n                    if (data.status == true) {\n                        Str.get_string('client:reportdownload', 'local_log_sender').done(function (str) {\n                            var content = $('<a href=\"' + data.path + '\" target=\"_blank\">' + str + '</a>').prepend(dlicon);\n                            $('#report-area').removeClass('alert-warning').addClass('alert-success')\n                                .html(content);\n                        });\n\n                        clearInterval(this.polling);\n                        return;\n                    }\n                }.bind(this),\n                fail: Notification.exception\n            }]);\n        };\n\n        return {\n            generateReport: function (requestorId, userId, userName, contextId) {\n                return new GenerateReport(requestorId, userId, userName, contextId);\n            }\n        };\n    }\n);\n"],"names":["define","$","Ajax","Notification","Str","Url","GenerateReport","requestorId","userId","userName","contextId","parseInt","start","end","timer","file","formdata","polling","click","e","preventDefault","startDate","Math","floor","document","querySelector","valueAsNumber","endDate","completion","this","checkCompletion","icon","attr","imageUrl","alert","get_string","requestorid","userid","username","startdate","enddate","contextid","call","methodname","args","jsonformdata","JSON","stringify","done","str","addClass","html","prepend","that","setInterval","pollFile","bind","fail","exception","prototype","length","dlicon","data","status","content","path","removeClass","clearInterval","generateReport"],"mappings":"AAAAA,0CAAO,CAAC,SACJ,YACA,oBACA,WACA,aACA,SAAUC,EAAGC,KAAMC,aAAcC,IAAKC,SAG9BC,eAAiB,SAAUC,YAAaC,OAAQC,SAAUC,gBACrDH,YAAcI,SAASJ,kBACvBC,OAASG,SAASH,aAClBC,SAAWA,cACXG,MAAQ,UACRC,IAAM,UACNH,UAAYA,eACZI,MAAQ,UACRC,MAAO,OACPC,SAAW,QACXC,QAAU,KAEfhB,EAAE,eAAeiB,MAAM,SAAUC,GAC7BA,EAAEC,uBAEIC,UAAYC,KAAKC,MAAMC,SAASC,cAAc,gBAAgBC,cAAgB,KAC9EC,QAAUL,KAAKC,MAAMC,SAASC,cAAc,cAAcC,cAAgB,KAC1EE,WAAaC,KAAKC,gBAAgBT,UAAWM,SAE7CI,KAAO9B,EAAE,aACf8B,KAAKC,KAAK,MAAO,WACjBD,KAAKC,KAAK,QAAS,WACnBD,KAAKC,KAAK,QAAS,gCACnBD,KAAKC,KAAK,MAAO3B,IAAI4B,SAAS,UAAW,sBAEpCL,kBACMzB,aAAa+B,MAChB9B,IAAI+B,WAAW,SACf/B,IAAI+B,WAAW,wBAAyB,yBAI5CnB,SAAW,CACXoB,YAAaP,KAAKtB,YAClB8B,OAAQR,KAAKrB,OACb8B,SAAUT,KAAKpB,SACf8B,UAAWlB,UACXmB,QAASb,QACTc,UAAWZ,KAAKnB,gBAGfM,SAAWA,SAEhBd,KAAKwC,KAAK,CAAC,CACPC,WAAY,wCACZC,KAAM,CAAEC,aAAcC,KAAKC,UAAU/B,WACrCgC,KAAM,WACF5C,IAAI+B,WAAW,0BAA2B,oBAAoBa,MAAK,SAAUC,KACzEhD,EAAE,gBAAgBiD,SAAS,iBACtBC,KAAKF,KAAKG,QAAQrB,aAGvBsB,KAAOxB,KAGPwB,KAAKpC,QAAUqC,YAAYC,SAASC,KAAKH,MAAO,OAEtDG,KAAK3B,MACP4B,KAAMtD,aAAauD,cAEzBF,KAAK3B,QAGXvB,eAAeqD,UAAU7B,gBAAkB,SAAUT,UAAWM,gBACpC,GAApBN,UAAUuC,QAAiC,GAAlBjC,QAAQiC,YAMrCL,SAAW,iBACLM,OAAS5D,EAAE,UACjB4D,OAAO7B,KAAK,MAAO,YACnB6B,OAAO7B,KAAK,QAAS,YACrB6B,OAAO7B,KAAK,QAAS,yBACrB6B,OAAO7B,KAAK,MAAO3B,IAAI4B,SAAS,WAAY,qBAE5C/B,KAAKwC,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CAAEC,aAAcC,KAAKC,UAAUlB,KAAKb,WAC1CgC,KAAM,SAAUc,SACO,GAAfA,KAAKC,cACL3D,IAAI+B,WAAW,wBAAyB,oBAAoBa,MAAK,SAAUC,SACnEe,QAAU/D,EAAE,YAAc6D,KAAKG,KAAO,qBAAuBhB,IAAM,QAAQG,QAAQS,QACvF5D,EAAE,gBAAgBiE,YAAY,iBAAiBhB,SAAS,iBACnDC,KAAKa,iBAGdG,cAActC,KAAKZ,UAGzBuC,KAAK3B,MACP4B,KAAMtD,aAAauD,oBAIpB,CACHU,eAAgB,SAAU7D,YAAaC,OAAQC,SAAUC,kBAC9C,IAAIJ,eAAeC,YAAaC,OAAQC,SAAUC"}